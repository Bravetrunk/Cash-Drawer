<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏¥‡πâ‡∏ô‡∏ä‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î - Tonkla</title>
<style>
/* Keep all existing styles as they are */
* {margin: 0;padding: 0;box-sizing: border-box;-webkit-tap-highlight-color: transparent;}
body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Kanit', sans-serif;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);min-height: 100vh;padding: 10px;animation: gradientShift 10s ease infinite;background-size: 200% 200%;}
@keyframes gradientShift {0% { background-position: 0% 50%; }50% { background-position: 100% 50%; }100% { background-position: 0% 50%; }}
.container {max-width: 1200px;margin: 0 auto;background: white;border-radius: 15px;padding: 15px;box-shadow: 0 10px 30px rgba(0,0,0,0.2);animation: slideIn 0.5s ease;}
@keyframes slideIn {from {opacity: 0;transform: translateY(30px);}to {opacity: 1;transform: translateY(0);}}
h1 {text-align: center;color: #333;margin-bottom: 15px;font-size: clamp(1.2rem, 4vw, 2rem);animation: fadeInDown 0.8s ease;}
@keyframes fadeInDown {from {opacity: 0;transform: translateY(-20px);}to {opacity: 1;transform: translateY(0);}}
h2 {color: #555;margin: 15px 0;padding: 8px;background: #f8f9fa;border-radius: 8px;font-size: clamp(0.9rem, 3vw, 1.1rem);}
h3 {color: #666;margin: 10px 0;font-size: clamp(0.85rem, 2.5vw, 1rem);}
.date-info {text-align: center;font-size: clamp(0.8rem, 2.5vw, 1.1rem);color: #666;margin-bottom: 15px;}

/* Navigation Tabs */
.nav-tabs {display: flex;gap: 10px;margin-bottom: 20px;border-bottom: 2px solid #e0e0e0;padding-bottom: 0;}
.nav-tab {padding: 12px 20px;background: #f8f9fa;border: none;border-radius: 10px 10px 0 0;cursor: pointer;font-size: clamp(0.85rem, 2.5vw, 1rem);color: #666;transition: all 0.3s ease;position: relative;font-weight: 500;}
.nav-tab.active {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);color: white;transform: translateY(-2px);}
.nav-tab:hover {background: #e9ecef;}
.nav-tab.active:hover {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);}
.tab-content {display: none;animation: fadeIn 0.5s ease;}
.tab-content.active {display: block;}

/* Staff Input Section */
.staff-section {margin: 15px 0;padding: 15px;background: #f8f9fa;border-radius: 10px;animation: fadeIn 0.8s ease;}
.staff-input {display: flex;align-items: center;gap: 10px;flex-wrap: wrap;}
.staff-input label {font-weight: 500;color: #555;font-size: clamp(0.85rem, 2.5vw, 1rem);}
.staff-input input {flex: 1;min-width: 150px;padding: 10px;border: 2px solid #ddd;border-radius: 5px;font-size: clamp(0.9rem, 2.5vw, 1rem);transition: all 0.3s ease;}
.staff-input input:focus {outline: none;border-color: #667eea;box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);}

/* Cash sections and other existing styles remain the same */
.cash-section, .transaction-section, .summary-section {margin: 20px 0;padding: 15px;border: 2px solid #e0e0e0;border-radius: 12px;background: #fafafa;animation: fadeIn 0.8s ease;}
@keyframes fadeIn {from { opacity: 0; }to { opacity: 1; }}
.denomination-grid {display: grid;grid-template-columns: 1fr;gap: 20px;margin: 15px 0;}
.bills-section, .coins-section {background: white;padding: 15px;border-radius: 10px;box-shadow: 0 2px 10px rgba(0,0,0,0.1);transition: transform 0.3s ease, box-shadow 0.3s ease;}
.bills-section:active, .coins-section:active {transform: scale(0.98);}
.input-row {display: grid;grid-template-columns: minmax(70px, 1fr) minmax(60px, 80px) minmax(70px, 1fr);align-items: center;gap: 8px;margin: 8px 0;padding: 5px;animation: slideInLeft 0.5s ease;}
@keyframes slideInLeft {from {opacity: 0;transform: translateX(-20px);}to {opacity: 1;transform: translateX(0);}}
.input-row label {font-weight: 500;color: #555;font-size: clamp(0.8rem, 2.5vw, 0.95rem);white-space: nowrap;}
.input-row input {padding: 8px 4px;border: 2px solid #ddd;border-radius: 5px;font-size: clamp(0.85rem, 2.5vw, 1rem);text-align: center;transition: all 0.3s ease;width: 100%;-webkit-appearance: none;-moz-appearance: textfield;}
.input-row input::-webkit-inner-spin-button,.input-row input::-webkit-outer-spin-button {-webkit-appearance: none;margin: 0;}
.input-row input:focus {outline: none;border-color: #667eea;box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);}
.subtotal {text-align: right;font-weight: bold;color: #667eea;transition: all 0.3s ease;font-size: clamp(0.8rem, 2.5vw, 0.95rem);white-space: nowrap;overflow: hidden;text-overflow: ellipsis;}
.subtotal.animated {animation: pulse 0.5s ease;}
@keyframes pulse {0% { transform: scale(1); }50% { transform: scale(1.1); }100% { transform: scale(1); }}
.total-section {text-align: center;padding: 12px;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius: 10px;color: white;transition: transform 0.3s ease;margin-top: 15px;}
.total-section:active {transform: scale(0.98);}
.total-section h3 {color: white;font-size: clamp(0.9rem, 3vw, 1.1rem);}
.transaction-section .input-group {display: flex;flex-direction: column;gap: 10px;margin: 15px 0;padding: 12px;background: white;border-radius: 8px;transition: all 0.3s ease;}
.input-group:active {box-shadow: 0 2px 10px rgba(0,0,0,0.1);}
.input-group label {font-weight: 500;color: #555;font-size: clamp(0.85rem, 2.5vw, 1rem);margin-bottom: 5px;}
.input-group input, .input-group textarea {width: 100%;padding: 10px;border: 2px solid #ddd;border-radius: 5px;font-size: clamp(0.9rem, 2.5vw, 1rem);transition: all 0.3s ease;-webkit-appearance: none;font-family: inherit;}
.input-group input:focus, .input-group textarea:focus {outline: none;border-color: #667eea;}
.summary-grid {display: grid;grid-template-columns: 1fr;gap: 15px;}
.summary-item {text-align: center;padding: 15px;background: white;border-radius: 10px;box-shadow: 0 2px 10px rgba(0,0,0,0.1);transition: all 0.3s ease;position: relative;}
.summary-item:active {transform: scale(0.98);}
.summary-item label {display: block;color: #666;margin-bottom: 8px;font-size: clamp(0.8rem, 2.5vw, 0.95rem);}
.summary-item span {font-size: clamp(1.2rem, 4vw, 1.5rem);font-weight: bold;color: #333;}
.difference-status {position: absolute;top: -10px;right: -10px;width: 40px;height: 40px;border-radius: 50%;display: flex;align-items: center;justify-content: center;font-size: 1.2rem;background: white;box-shadow: 0 2px 8px rgba(0,0,0,0.2);animation: bounceIn 0.5s ease;}
@keyframes bounceIn {0% { transform: scale(0); }50% { transform: scale(1.2); }100% { transform: scale(1); }}
.difference.over {background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);}
.difference.under {background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);}
.difference.exact {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);}
.difference label, .difference span {color: white;}
.button-section {display: flex;flex-direction: column;gap: 12px;margin-top: 20px;}
.btn-primary, .btn-secondary {padding: 14px 20px;font-size: clamp(0.95rem, 3vw, 1.1rem);border: none;border-radius: 10px;cursor: pointer;transition: all 0.3s ease;position: relative;overflow: hidden;width: 100%;touch-action: manipulation;}
.btn-primary {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);color: white;}
.btn-secondary {background: #6c757d;color: white;}
.btn-primary:active, .btn-secondary:active {transform: scale(0.98);}
.btn-primary:disabled, .btn-secondary:disabled {opacity: 0.6;cursor: not-allowed;}
.loading {display: inline-block;width: 16px;height: 16px;border: 2px solid rgba(255,255,255,.3);border-radius: 50%;border-top-color: white;animation: spin 1s ease-in-out infinite;}
@keyframes spin {to { transform: rotate(360deg); }}
.toast {position: fixed;top: 20px;right: 20px;left: 20px;margin: 0 auto;max-width: 350px;padding: 12px 20px;background: white;border-radius: 10px;box-shadow: 0 5px 20px rgba(0,0,0,0.2);display: none;animation: slideInRight 0.5s ease;z-index: 1000;font-size: clamp(0.85rem, 2.5vw, 1rem);}
@keyframes slideInRight {from {transform: translateX(100%);}to {transform: translateX(0);}}
.toast.success {border-left: 4px solid #43e97b;}
.toast.error {border-left: 4px solid #f5576c;}

/* Responsive styles */
@media (min-width: 600px) and (max-width: 1024px) {
.container {padding: 20px;}
.denomination-grid {grid-template-columns: 1fr 1fr;}
.transaction-section .input-group {flex-direction: row;justify-content: space-between;align-items: center;}
.input-group input {width: 200px;}
.summary-grid {grid-template-columns: repeat(3, 1fr);}
.button-section {flex-direction: row;justify-content: center;}
.btn-primary, .btn-secondary {width: auto;padding: 14px 35px;}
}

@media (min-width: 1025px) {
body {padding: 20px;}
.container {padding: 30px;border-radius: 20px;}
.denomination-grid {grid-template-columns: 1fr 1fr;}
.input-row {grid-template-columns: 100px 80px 100px;gap: 10px;margin: 10px 0;}
.transaction-section .input-group {flex-direction: row;justify-content: space-between;align-items: center;}
.input-group label {margin-bottom: 0;}
.input-group input {width: 200px;}
.summary-grid {grid-template-columns: repeat(3, 1fr);}
.button-section {flex-direction: row;justify-content: center;}
.btn-primary, .btn-secondary {width: auto;padding: 15px 40px;}
}
</style>
</head>
<body>
<div class="container">
<h1>üè™ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏¥‡πâ‡∏ô‡∏ä‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</h1>
<div class="date-info">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="currentDate"></span></div>

<!-- Navigation Tabs -->
<div class="nav-tabs">
<button class="nav-tab active" onclick="switchTab('input-tab')">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
<button class="nav-tab" onclick="switchTab('history-tab')">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
</div>

<!-- Input Tab Content -->
<div id="input-tab" class="tab-content active">
<!-- Staff Name Input -->
<div class="staff-section">
<div class="staff-input">
<label for="staffName">üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
<input type="text" id="staffName" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" value="Supanut Chailungka">
</div>
</div>

<div class="cash-section">
<h2>üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏∞ (Opening Cash)</h2>
<div class="denomination-grid">
<div class="bills-section">
<h3>‡∏ò‡∏ô‡∏ö‡∏±‡∏ï‡∏£</h3>
<div class="input-row">
<label>1,000 ‡∏ö‡∏≤‡∏ó:</label>
<input type="number" inputmode="numeric" pattern="[0-9]*" class="opening" data-value="1000" min="0" value="0">
<span class="subtotal">0</span>
</div>
<div class="input-row">
<label>500 ‡∏ö‡∏≤‡∏ó:</label>
<input type="number" inputmode="numeric" pattern="[0-9]*" class="opening" data-value="500" min="0" value="0">
<span class="subtotal">0</span>
</div>
<div class="input-row">
<label>100 ‡∏ö‡∏≤‡∏ó:</label>
<input type="number" inputmode="numeric" pattern="[0-9]*" class="opening" data-value="100" min="0" value="0">
<span class="subtotal">0</span>
</div>
<div class="input-row">
<label>50 ‡∏ö‡∏≤‡∏ó:</label>
<input type="number" inputmode="numeric" pattern="[0-9]*" class="opening" data-value="50" min="0" value="0">
<span class="subtotal">0</span>
</div>
<div class="input-row">
<label>20 ‡∏ö‡∏≤‡∏ó:</label>
<input type="number" inputmode="numeric" pattern="[0-9]*" class="opening" data-value="20" min="0" value="0">
<span class="subtotal">0</span>
</div>
</div>
<div class="coins-section">
<h3>‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</h3>
<div class="input-row">
<label>10 ‡∏ö‡∏≤‡∏ó:</label>
<input type="number" inputmode="numeric" pattern="[0-9]*" class="opening" data-value="10" min="0" value="0">
<span class="subtotal">0</span>
</div>
<div class="input-row">
<label>5 ‡∏ö‡∏≤‡∏ó:</label>
<input type="number" inputmode="numeric" pattern="[0-9]*" class="opening" data-value="5" min="0" value="0">
<span class="subtotal">0</span>
</div>
<div class="input-row">
<label>2 ‡∏ö‡∏≤‡∏ó:</label>
<input type="number" inputmode="numeric" pattern="[0-9]*" class="opening" data-value="2" min="0" value="0">
<span class="subtotal">0</span>
</div>
<div class="input-row">
<label>1 ‡∏ö‡∏≤‡∏ó:</label>
<input type="number" inputmode="numeric" pattern="[0-9]*" class="opening" data-value="1" min="0" value="0">
<span class="subtotal">0</span>
</div>
</div>
</div>
<div class="total-section">
<h3>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏∞: <span id="openingTotal">0</span> ‡∏ö‡∏≤‡∏ó</h3>
</div>
</div>

<div class="transaction-section">
<h2>üí≥ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏±‡∏ô</h2>
<div class="input-group">
<label>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Revenue):</label>
<input type="number" inputmode="decimal" id="revenue" min="0" step="0.01" value="0">
</div>
<div class="input-group">
<label>‡∏¢‡∏≠‡∏î PromptPay:</label>
<input type="number" inputmode="decimal" id="promptpay" min="0" step="0.01" value="0">
</div>
<div class="input-group">
<label>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Notes):</label>
<textarea id="notes" rows="3" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
</div>
</div>

<div class="cash-section">
<h2>üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏õ‡∏¥‡∏î‡∏Å‡∏∞ (Closing Cash)</h2>
<div class="denomination-grid">
<div class="bills-section">
<h3>‡∏ò‡∏ô‡∏ö‡∏±‡∏ï‡∏£</h3>
<div class="input-row">
<label>1,000 ‡∏ö‡∏≤‡∏ó:</label>
<input type="number" inputmode="numeric" pattern="[0-9]*" class="closing" data-value="1000" min="0" value="0">
<span class="subtotal">0</span>
</div>
<div class="input-row">
<label>500 ‡∏ö‡∏≤‡∏ó:</label>
<input type="number" inputmode="numeric" pattern="[0-9]*" class="closing" data-value="500" min="0" value="0">
<span class="subtotal">0</span>
</div>
<div class="input-row">
<label>100 ‡∏ö‡∏≤‡∏ó:</label>
<input type="number" inputmode="numeric" pattern="[0-9]*" class="closing" data-value="100" min="0" value="0">
<span class="subtotal">0</span>
</div>
<div class="input-row">
<label>50 ‡∏ö‡∏≤‡∏ó:</label>
<input type="number" inputmode="numeric" pattern="[0-9]*" class="closing" data-value="50" min="0" value="0">
<span class="subtotal">0</span>
</div>
<div class="input-row">
<label>20 ‡∏ö‡∏≤‡∏ó:</label>
<input type="number" inputmode="numeric" pattern="[0-9]*" class="closing" data-value="20" min="0" value="0">
<span class="subtotal">0</span>
</div>
</div>
<div class="coins-section">
<h3>‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</h3>
<div class="input-row">
<label>10 ‡∏ö‡∏≤‡∏ó:</label>
<input type="number" inputmode="numeric" pattern="[0-9]*" class="closing" data-value="10" min="0" value="0">
<span class="subtotal">0</span>
</div>
<div class="input-row">
<label>5 ‡∏ö‡∏≤‡∏ó:</label>
<input type="number" inputmode="numeric" pattern="[0-9]*" class="closing" data-value="5" min="0" value="0">
<span class="subtotal">0</span>
</div>
<div class="input-row">
<label>2 ‡∏ö‡∏≤‡∏ó:</label>
<input type="number" inputmode="numeric" pattern="[0-9]*" class="closing" data-value="2" min="0" value="0">
<span class="subtotal">0</span>
</div>
<div class="input-row">
<label>1 ‡∏ö‡∏≤‡∏ó:</label>
<input type="number" inputmode="numeric" pattern="[0-9]*" class="closing" data-value="1" min="0" value="0">
<span class="subtotal">0</span>
</div>
</div>
</div>
<div class="total-section">
<h3>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏õ‡∏¥‡∏î‡∏Å‡∏∞: <span id="closingTotal">0</span> ‡∏ö‡∏≤‡∏ó</h3>
</div>
</div>

<div class="summary-section">
<h2>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>
<div class="summary-grid">
<div class="summary-item">
<label>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ:</label>
<span id="expectedCash">0</span> ‡∏ö‡∏≤‡∏ó
</div>
<div class="summary-item">
<label>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ:</label>
<span id="actualCash">0</span> ‡∏ö‡∏≤‡∏ó
</div>
<div class="summary-item difference exact" id="differenceBox">
<div class="difference-status" id="statusIcon">‚úÖ</div>
<label>‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á:</label>
<span id="difference">0</span> ‡∏ö‡∏≤‡∏ó
<div id="differenceText" style="margin-top: 10px; font-size: 0.9rem;"></div>
</div>
</div>
</div>

<div class="button-section">
<button id="saveBtn" class="btn-primary">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
<button id="resetBtn" class="btn-secondary">üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
</div>
</div>

<!-- History Tab Content -->
<div id="history-tab" class="tab-content">
<h2>üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
<!-- History content here -->
</div>
</div>

<div class="toast" id="toast"></div>

<script>
// Google Apps Script Web App URL
const GOOGLE_SCRIPT_URL = '<https://script.google.com/macros/s/AKfycbyuVwKg-DAWrQVNFLBqnxFCxuMbElUoJPXLL7IeqJNZY3iuIvavfEHcsmWxMiAbWUVN/exec>';

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

function initializeApp() {
    setCurrentDate();
    attachEventListeners();
    loadFromLocalStorage();

    // Initial calculation
    calculateAllTotals();

    // Update date every second
    setInterval(setCurrentDate, 1000);
}

function setCurrentDate() {
    const now = new Date();
    const options = {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        timeZone: 'Asia/Bangkok'
    };
    document.getElementById('currentDate').textContent =
        now.toLocaleDateString('th-TH', options);
}

function attachEventListeners() {
    // Denomination inputs (opening and closing)
    document.querySelectorAll('.opening, .closing').forEach(input => {
        input.addEventListener('input', function() {
            handleDenominationInput(this);
        });
        input.addEventListener('change', function() {
            handleDenominationInput(this);
        });
        input.addEventListener('focus', function() {
            this.select();
        });
    });

    // Transaction inputs
    document.getElementById('revenue').addEventListener('input', calculateSummary);
    document.getElementById('revenue').addEventListener('change', calculateSummary);
    document.getElementById('promptpay').addEventListener('input', calculateSummary);
    document.getElementById('promptpay').addEventListener('change', calculateSummary);

    // Buttons
    document.getElementById('saveBtn').addEventListener('click', saveToGoogleSheets);
    document.getElementById('resetBtn').addEventListener('click', resetForm);
}

function handleDenominationInput(input) {
    // Ensure non-negative integer values
    let value = parseInt(input.value) || 0;
    if (value < 0) value = 0;
    input.value = value;

    // Calculate subtotal for this denomination
    calculateSubtotal(input);

    // Update totals
    if (input.classList.contains('opening')) {
        calculateOpeningTotal();
    } else if (input.classList.contains('closing')) {
        calculateClosingTotal();
    }

    // Update summary
    calculateSummary();

    // Save to localStorage
    saveToLocalStorage();
}

function calculateSubtotal(input) {
    const quantity = parseInt(input.value) || 0;
    const denominationValue = parseInt(input.dataset.value) || 0;
    const subtotal = quantity * denominationValue;

    // Update subtotal display
    const subtotalElement = input.parentElement.querySelector('.subtotal');
    if (subtotalElement) {
        subtotalElement.textContent = subtotal.toLocaleString('th-TH');

        // Add animation effect
        subtotalElement.classList.add('animated');
        setTimeout(() => {
            subtotalElement.classList.remove('animated');
        }, 300);
    }

    return subtotal;
}

function calculateOpeningTotal() {
    let total = 0;

    document.querySelectorAll('.opening').forEach(input => {
        const quantity = parseInt(input.value) || 0;
        const denominationValue = parseInt(input.dataset.value) || 0;
        total += quantity * denominationValue;
    });

    // Update display with animation
    const element = document.getElementById('openingTotal');
    if (element) {
        animateValue(element, parseInt(element.textContent.replace(/,/g, '')) || 0, total, 300);
    }

    return total;
}

function calculateClosingTotal() {
    let total = 0;

    document.querySelectorAll('.closing').forEach(input => {
        const quantity = parseInt(input.value) || 0;
        const denominationValue = parseInt(input.dataset.value) || 0;
        total += quantity * denominationValue;
    });

    // Update display with animation
    const element = document.getElementById('closingTotal');
    if (element) {
        animateValue(element, parseInt(element.textContent.replace(/,/g, '')) || 0, total, 300);
    }

    return total;
}

function calculateSummary() {
    // Get all values
    const openingCash = calculateOpeningTotal();
    const revenue = parseFloat(document.getElementById('revenue').value) || 0;
    const promptpay = parseFloat(document.getElementById('promptpay').value) || 0;
    const closingCash = calculateClosingTotal();

    // Calculate expected vs actual
    const expectedCash = openingCash + revenue - promptpay;
    const actualCash = closingCash;
    const difference = actualCash - expectedCash;

    // Update displays with animation
    const expectedElement = document.getElementById('expectedCash');
    const actualElement = document.getElementById('actualCash');
    const differenceElement = document.getElementById('difference');

    if (expectedElement) {
        animateValue(expectedElement,
            parseInt(expectedElement.textContent.replace(/,/g, '')) || 0,
            Math.round(expectedCash), 300);
    }

    if (actualElement) {
        animateValue(actualElement,
            parseInt(actualElement.textContent.replace(/,/g, '')) || 0,
            Math.round(actualCash), 300);
    }

    if (differenceElement) {
        animateValue(differenceElement,
            parseInt(differenceElement.textContent.replace(/,/g, '')) || 0,
            Math.round(difference), 300);
    }

    // Update status indicator
    updateDifferenceStatus(difference);

    // Save to localStorage
    saveToLocalStorage();
}

function updateDifferenceStatus(difference) {
    const diffBox = document.getElementById('differenceBox');
    const statusIcon = document.getElementById('statusIcon');
    const diffText = document.getElementById('differenceText');

    if (!diffBox || !statusIcon || !diffText) return;

    // Remove all status classes
    diffBox.classList.remove('over', 'under', 'exact');

    // Apply appropriate status
    if (Math.abs(difference) < 1) {
        // Exact match (considering floating point)
        diffBox.classList.add('exact');
        statusIcon.innerHTML = '‚úÖ';
        statusIcon.style.background = '#667eea';
        diffText.textContent = '‡∏û‡∏≠‡∏î‡∏µ';
    } else if (difference > 0) {
        // Over
        diffBox.classList.add('over');
        statusIcon.innerHTML = 'üìà';
        statusIcon.style.background = '#43e97b';
        diffText.textContent = '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô';
    } else {
        // Under
        diffBox.classList.add('under');
        statusIcon.innerHTML = 'üìâ';
        statusIcon.style.background = '#f5576c';
        diffText.textContent = '‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≤‡∏î';
    }

    // Animate status icon
    statusIcon.style.animation = 'none';
    setTimeout(() => {
        statusIcon.style.animation = 'bounceIn 0.5s ease';
    }, 10);
}

function animateValue(element, start, end, duration) {
    if (!element) return;

    // Clear any existing animation
    if (element.animationTimer) {
        clearInterval(element.animationTimer);
    }

    const startTime = Date.now();
    const endTime = startTime + duration;
    const range = end - start;

    element.animationTimer = setInterval(() => {
        const now = Date.now();
        const remaining = Math.max(endTime - now, 0);
        const progress = 1 - (remaining / duration);
        const value = Math.round(start + (range * progress));

        element.textContent = value.toLocaleString('th-TH');

        if (remaining === 0) {
            clearInterval(element.animationTimer);
            element.animationTimer = null;
        }
    }, 16); // ~60fps
}

function calculateAllTotals() {
    // Calculate all subtotals first
    document.querySelectorAll('.opening, .closing').forEach(input => {
        calculateSubtotal(input);
    });

    // Then calculate totals
    calculateOpeningTotal();
    calculateClosingTotal();
    calculateSummary();
}

function saveToLocalStorage() {
    const data = {
        staffName: document.getElementById('staffName').value,
        opening: {},
        closing: {},
        revenue: document.getElementById('revenue').value,
        promptpay: document.getElementById('promptpay').value,
        notes: document.getElementById('notes').value,
        timestamp: new Date().toISOString()
    };

    // Save opening denominations
    document.querySelectorAll('.opening').forEach(input => {
        data.opening[input.dataset.value] = input.value;
    });

    // Save closing denominations
    document.querySelectorAll('.closing').forEach(input => {
        data.closing[input.dataset.value] = input.value;
    });

    localStorage.setItem('cashierData', JSON.stringify(data));
}

function loadFromLocalStorage() {
    const savedData = localStorage.getItem('cashierData');
    if (!savedData) return;

    try {
        const data = JSON.parse(savedData);

        // Load staff name
        if (data.staffName) {
            document.getElementById('staffName').value = data.staffName;
        }

        // Load opening denominations
        if (data.opening) {
            document.querySelectorAll('.opening').forEach(input => {
                const value = data.opening[input.dataset.value] || '0';
                input.value = value;
            });
        }

        // Load closing denominations
        if (data.closing) {
            document.querySelectorAll('.closing').forEach(input => {
                const value = data.closing[input.dataset.value] || '0';
                input.value = value;
            });
        }

        // Load transaction data
        document.getElementById('revenue').value = data.revenue || '0';
        document.getElementById('promptpay').value = data.promptpay || '0';
        document.getElementById('notes').value = data.notes || '';

        // Recalculate all totals
        calculateAllTotals();

    } catch (error) {
        console.error('Error loading data from localStorage:', error);
    }
}

function resetForm() {
    if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
        return;
    }

    // Reset all number inputs
    document.querySelectorAll('input[type="number"]').forEach(input => {
        input.value = '0';
    });

    // Reset notes
    document.getElementById('notes').value = '';

    // Reset all subtotals
    document.querySelectorAll('.subtotal').forEach(span => {
        span.textContent = '0';
    });

    // Recalculate everything
    calculateAllTotals();

    // Clear localStorage
    localStorage.removeItem('cashierData');

    showToast('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ üîÑ', 'success');
}

async function saveToGoogleSheets() {
    const btn = document.getElementById('saveBtn');
    const originalText = btn.innerHTML;

    // Validation
    const staffName = document.getElementById('staffName').value.trim();
    if (!staffName) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‚ùå', 'error');
        document.getElementById('staffName').focus();
        return;
    }

    // Show loading state
    btn.innerHTML = '<span class="loading"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
    btn.disabled = true;

    // Prepare data
    const sessionId = generateSessionId();
    const now = new Date();
    const formattedDate = now.toISOString().split('T')[0];
    const formattedTime = now.toTimeString().split(' ')[0];

    // Get calculated values
    const openingTotal = calculateOpeningTotal();
    const closingTotal = calculateClosingTotal();
    const revenue = parseFloat(document.getElementById('revenue').value) || 0;
    const promptpay = parseFloat(document.getElementById('promptpay').value) || 0;
    const expectedCash = openingTotal + revenue - promptpay;
    const actualCash = closingTotal;
    const difference = actualCash - expectedCash;
    const status = Math.abs(difference) < 1 ? '‡∏û‡∏≠‡∏î‡∏µ' : difference > 0 ? '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô' : '‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≤‡∏î';
    const notes = document.getElementById('notes').value || '';

    // Create form data
    const formData = new FormData();
    formData.append('sessionId', sessionId);
    formData.append('date', formattedDate);
    formData.append('time', formattedTime);
    formData.append('staffName', staffName);
    formData.append('openingTotal', openingTotal);
    formData.append('revenue', revenue);
    formData.append('promptpay', promptpay);
    formData.append('expectedCash', expectedCash);
    formData.append('closingTotal', closingTotal);
    formData.append('actualCash', actualCash);
    formData.append('difference', difference);
    formData.append('status', status);
    formData.append('notes', notes);

    try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: formData
        });

        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ', 'success');

        setTimeout(() => {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                resetForm();
            }
        }, 1000);

    } catch (error) {
        console.error('Error:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÅ‡∏ï‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚ö†Ô∏è', 'error');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

function generateSessionId() {
    const date = new Date();
    const random = Math.floor(Math.random() * 10000);
    return `SESSION_${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}_${date.getHours().toString().padStart(2,'0')}${date.getMinutes().toString().padStart(2,'0')}_${random}`;
}

function showToast(message, type) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type}`;
    toast.style.display = 'block';

    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.5s ease';
        setTimeout(() => {
            toast.style.display = 'none';
            toast.style.animation = '';
        }, 500);
    }, 3000);
}

function switchTab(tabId) {
    // Update tab buttons
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');

    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(tabId).classList.add('active');
}
</script>
</body>
</html>
